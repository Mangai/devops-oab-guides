## Create APB

```
User Flow:

- apb init mysql-digital-ocean-apb --bindable

- cd mysql-digital-ocean-apb

- take a look at apb.yml

- edit apb.yml and paste these content:
  https://github.com/tahonen/mysql-digital-ocean-apb/blob/master/apb.yml
  
- take a look at playbooks. explain action playbooks

- copy `roles` and `playbooks` from https://github.com/tahonen/mysql-digital-ocean-apb to mysql-digital-ocean-apb

- expalin the apb publishing process and the Dockerfile

- Paste the Dockerfile content (from https://github.com/tahonen/mysql-digital-ocean-apb without the LABEL) to mysql-digital-ocean-apb/Dockerfile

----
FROM ansibleplaybookbundle/apb-base  
LABEL "com.redhat.apb.spec"=  
RUN yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-$(rpm -E '%{rhel}').noarch.rpm && yum -y update && yum -y install python git python-pip && yum clean all 
RUN pip install --upgrade pip && pip install 'dopy>=0.3.7,<=0.3.7'  
RUN chown -R apb:0 /opt/apb && chmod -R g=u /opt/apb /etc/passwd  
COPY playbooks /opt/apb/actions 
COPY roles /opt/apb/actions/roles 
RUN chmod -R g=u /opt/{ansible,apb} 
USER apb 
ENV ANSIBLE_HOST_KEY_CHECKING false
----

- apb prepare

- take a log at Dockerfile again...LABEL added

- apb build --dockerfile Dockerfile.final

- oc login -u admin

- apb push --registry-route docker-registry-default.app-GUID.generic.opentlc.com
  # apb push --registry-route $(oc get routes docker-registry -n default --no-headers | awk '{print $2}')

- deploy via web console




https://github.com/VeerMuchandi/Using-OpenShift-APB

Shell script for apb tool as a docker image: https://raw.githubusercontent.com/ansibleplaybookbundle/ansible-playbook-bundle/master/scripts/apb-docker-run.sh










Dev Cluster Setup:
    
TODO:
 - configure service broker
 - recreate registry route on dev cluster
 - copy /etc/origin/master/ca.crt from DEV master to /etc/docker/certs.d/docker-registry-default.app-GUID.generic.opentlc.com workstation

Defautl broker config: https://hastebin.com/uboquwinih.scala

Snippet from Ansible Service Broker config oc get configmap broker-config -n openshift-ansible-service-broker

Name has to end -apb since ansible service broker is using that string as whitelist filtering

openshift: 
  ...  
  namespace: openshift-ansible-service-broker
  ...
secrets:
- {apb_name: localregistry-mysql-digital-ocean-apb, secret: digital-ocean-api-key, title: digital-ocean-apikey}

create secret for Digital Ocean APi key

oc create secret generic digital-ocean-api-key --from-literal=api_key=YOUR_KEY_COMES_HERE -n openshift-ansible-service-broker

- oc rollout latest apb -n openshift-ansible-service-broker


Notes:
    
This is a secure registry. So you would get a certificate to connect to this registry as well. In a typical experimental cluster you may have used the default certificates that openshift configures for you. The ca.crt can be copied from /etc/origin/master/ca.crt to the host where you want to login from

Copy the certificate to the /etc/docker/certs.d/docker-registry-default.app-GUID.generic.opentlc.com

ls /etc/docker/certs.d/docker-registry-default.app-GUID.generic.opentlc.com/ca.crt

```
TODO:

* Create MySQL APB on Digital Ocean
* Delete MySQL deployment from STAGE
* Deploy the new MySQL APB in STAGE and wire to Catalog