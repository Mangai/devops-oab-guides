## Release Catalog Service to STAGE Environment

Change to the `cd-infra` repository working copy:

[source,shell]
----
$ cd cd-infra
----

Create a Jenkinsfile for the release pipeline:

[source,shell]
----
$ cat <<'EOF' > Jenkinsfile.release
def releaseTag

pipeline {
  agent {
      label 'maven'
  }
  stages {
    stage('Prepare') {
      steps {
        git url: 'http://{{GIT_HOSTNAME}}/{{GIT_USER}}/catalog-spring-boot.git'
        sh "git config --local user.email 'jenkins@cicd.com'"
        sh "git config --local user.name 'jenkins'"
        
        script {
          releaseTag = readMavenPom().getVersion().replace("-SNAPSHOT", "")
        }
      }
    }
    stage('Release Code') {
      environment {
        SCM_GIT_URL = sh(returnStdout: true, script: 'git config remote.origin.url').trim()
      }
      steps {
        script {
          openshift.withCluster() {
            withCredentials([usernamePassword(credentialsId: "${openshift.project()}-gogs-credentials", usernameVariable: "GOGS_USERNAME", passwordVariable: "GOGS_PASSWORD")]) {
              sh "mvn --batch-mode release:clean release:prepare release:perform -s .settings.xml"
            }
          }
        }
      }
    }
    stage('Release Image') {
      steps {
        script {
          openshift.withCluster() {
            echo "Releasing image version ${releaseTag}"
            openshift.tag("${openshift.project()}/catalog:latest", "${openshift.project()}/catalog:${releaseTag}")
            openshift.tag("${openshift.project()}/web-ui:latest", "${openshift.project()}/web-ui:${releaseTag}")
          }
        }
      }
    }    
    stage('Tear-down STAGE') {
      steps {
        script {
          openshift.withCluster() {
            openshift.withProject(env.STAGE_PROJECT) {
              openshift.raw('delete all,cm,pvc --all')
            }
          }
        }
      }
    }    
    stage('Deploy STAGE') {
      steps {
        script {
          openshift.withCluster() {
            def imageNamespace = openshift.project()
            openshift.withProject(env.STAGE_PROJECT) {
              def template = 'https://raw.githubusercontent.com/openshift-labs/devops-oab-labs/master/openshift/coolstore-template.yaml'
              openshift.apply(
                openshift.process("-f", template, "-p", "IMAGE_VERSION=${releaseTag}", "-p", "IMAGE_NAMESPACE=${imageNamespace}")
              )
            }
          }
        }
      }
    }    
  }
}
EOF
----


Add the Jenkinsfile to `cd-infra` git repository:

[source,shell]
----
$ git add Jenkinsfile.release
$ git commit -m "release pipeline added"
$ git push origin master
----

Release process invovles creating Git releases and tags in Gogs. Create a secret to hold the credentials for creating 
tags in Gogs (explain secret sync in Jenkins):

[source,shell]
----
$ oc create secret generic gogs-credentials --from-literal=username={{GIT_USER}} --from-literal=password={{GIT_PASSWORD}}
$ oc label secret gogs-credentials credential.sync.jenkins.openshift.io=true
----

Create the OpenShift pipeline definition to use the Jenkins file

[source,shell]
----
$ cat <<'EOF' > ~/pipeline-catalog-release.yml
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: catalog-release
spec:
  runPolicy: Serial
  source:
    git:
      ref: master
      uri: "{{GIT_HOSTNAME}}/{{GIT_USER}}/cd-infra.git"
    type: Git
  strategy:
    jenkinsPipelineStrategy:
      env:
        - name: NEXUS_URL
          value: "{{NEXUS_URL}}"
        - name: STAGE_PROJECT
          value: "stage{{PROJECT_SUFFIX}}"
      jenkinsfilePath: Jenkinsfile.release
    type: JenkinsPipeline
  triggers:
    - github:
        secret: CqPGlXcKJXXqKxW4Ye6z
      type: GitHub
    - generic:
        secret: 4LXwMdx9vhQY4WXbLcFR
      type: Generic
    - type: ConfigChange
EOF
----

Create an OpenShift pipeline:

[source,shell]
----
oc create -f ~/pipeline-catalog-release.yml
----
