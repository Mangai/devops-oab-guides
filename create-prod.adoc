## Promote Builds to Production


Login to PROD:

* Username: `{{PROD_USER}}`
* Password: `{{PROD_PASSWORD}}`

[source,shell]
----
$ oc login {{PROD_URL}}
----

Get the PROD token:

[source,shell]
----
$ oc whoami -t
----

Login back into the DEV cluster:

[source,shell]
----
$ oc login {{OPENSHIFT_URL}}
----

Create a secret to hold PROD environment credentials which are needed in the pipeline. 

[source,shell]
----
$ oc create secret generic prod-credentials --from-literal=username={{PROD_USERNAME}} --from-literal=password=PROD_TOKEN
$ oc label secret prod-credentials credential.sync.jenkins.openshift.io=true
----

Change to the `cd-infra` repository working copy:

[source,shell]
----
$ cd cd-infra
----

Create the Jenkinsfile for creating the PROD environment:

[source,shell]
----
$ cat <<'EOF' > Jenkinsfile.create-prod
def namespace, releaseTag, prodCluster, prodProject, prodToken

pipeline {
  agent {
      label 'skopeo'
  }
  stages {
    stage('Choose Release Version') {
      steps {
        script {
          openshift.withCluster() {
            namespace = openshift.project()
            prodCluster = env.PROD_MASTER.replace("https://","insecure://")
            withCredentials([usernamePassword(credentialsId: "${namespace}-prod-credentials", usernameVariable: "PROD_USER", passwordVariable: "PROD_TOKEN")]) {
              prodToken = env.PROD_TOKEN
            }

            def tags = openshift.selector("istag").objects().collect { it.metadata.name }.findAll { it.startsWith 'catalog:' }.collect { it.replaceAll(/catalog:(.*)/, "\$1") }.sort()
            timeout(5) {
              def inputs = input(
                ok: "Deploy",
                message: "Enter release version to promote to PROD",
                parameters: [
                  string(defaultValue: "prod", description: 'Name of the PROD project to create', name: 'PROD Project Name'),
                  choice(choices: tags.join('\n'), description: '', name: 'Release Version')
                ]
              )
              releaseTag = inputs['Release Version']
              prodProject = inputs['PROD Project Name']
            }
          }
        }
      }
    }
    stage('Create PROD') {
      steps {
        script {
          openshift.withCluster(prodCluster, prodToken) {
            openshift.newProject(prodProject, "--display-name='CoolStore PROD'")
          }
        }
      }
    }    
    stage('Promote Images to PROD') {
      steps {
        script {
          openshift.withCluster() {
            def srcCatalogRef = openshift.selector("istag", "catalog:${releaseTag}").object().image.dockerImageReference
            def srcWebRef = openshift.selector("istag", "web-ui:${releaseTag}").object().image.dockerImageReference
            def destCatalogRef = "${env.PROD_REGISTRY}/${prodProject}/catalog:${releaseTag}"
            def destWebRef = "${env.PROD_REGISTRY}/${prodProject}/web-ui:${releaseTag}"
            def srcToken = readFile "/run/secrets/kubernetes.io/serviceaccount/token"
            sh "skopeo copy docker://${srcCatalogRef} docker://${destCatalogRef} --src-creds openshift:${srcToken} --dest-creds openshift:${prodToken} --src-tls-verify=false --dest-tls-verify=false"
            sh "skopeo copy docker://${srcWebRef} docker://${destWebRef} --src-creds openshift:${srcToken} --dest-creds openshift:${prodToken} --src-tls-verify=false --dest-tls-verify=false"
          }
        }
      }
    }
    stage('Deploy to PROD') {
      steps {
        script {
          openshift.withCluster(prodCluster, prodToken) {
            openshift.withProject(prodProject) {
              def template = 'https://raw.githubusercontent.com/openshift-labs/devops-oab-labs/master/openshift/coolstore-apb-template.yaml'
              openshift.apply(
                openshift.process("-f", template, "-p", "IMAGE_VERSION=${releaseTag}")
              )
            }
          }
        }
      }
    }    
  }
}
EOF
----

Add the Jenkinsfile to `cd-infra` git repository:

[source,shell]
----
$ git add Jenkinsfile.create-prod
$ git commit -m "create prod pipeline added"
$ git push origin master
----

Create the OpenShift pipeline definition to use the Jenkins file

[source,shell]
----
$ cat <<'EOF' > ~/pipeline-create-prod.yml
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: coolstore-create-prod
spec:
  runPolicy: Serial
  source:
    git:
      ref: master
      uri: "{{GIT_HOSTNAME}}/{{GIT_USER}}/cd-infra.git"
    type: Git
  strategy:
    jenkinsPipelineStrategy:
      env:
        - name: PROD_REGISTRY
          value: "{{ PROD_REGISTRY }}"
        - name: PROD_MASTER
          value: "{{ PROD_MASTER }}"
        - name: PROD_PROJECT
          value: "prod{{ PROJECT_SUFFIX }}"
      jenkinsfilePath: Jenkinsfile.create-prod
    type: JenkinsPipeline
  triggers:
    - github:
        secret: CqPGlXcKJXXqKxW4Ye6z
      type: GitHub
    - generic:
        secret: 4LXwMdx9vhQY4WXbLcFR
      type: Generic
    - type: ConfigChange
EOF
----

Create an OpenShift pipeline:

[source,shell]
----
oc create -f ~/pipeline-create-prod.yml
----
